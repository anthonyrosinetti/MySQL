with layer1 as (
  select
    date,
    store,
    customer_id,
	customer_created_date,
    customer_is_omni_buyer,
    max(order_created_date) over w as last_customer_store_order_date,
    lag(order_created_date) over w as previous_last_customer_store_order_date,    
    min(order_created_date) over w as first_customer_store_order_date,
    -- count(distinct order_id) over w0 as store_orders_count,
    count(distinct case when order_created_date = date then order_id else null end) over w0 as orders_count,
    sum(case when order_created_date = date then ca_ttc else 0 end) over w0 as ca_ttc,
    sum(case when order_created_date = date then product_sold_units else 0 end) over w0 as order_sold_units
  from
    unnest(
            generate_date_array(
                PARSE_DATE("%Y%m%d", @DS_START_DATE),
                PARSE_DATE("%Y%m%d", @DS_END_DATE)
            )
        ) date
    left join
      `amasty-data.analysis.preanalysis_orders_splio`
      on order_created_date <= date
  window w0 as (
    partition by date,store,customer_id
  ),
  w as (
    partition by date,store,customer_id
    order by order_created_date asc
  )
)

select
  date,
  store,
  customer_id,
  max(customer_is_omni_buyer) as customer_is_omni_buyer,
  case when max(orders_count) > 0 then true else false end as customer_is_buyer,
  case
    when max(last_customer_store_order_date) >= date_sub(date,interval 12 month) then 'active'
    else 'inactive'
  end as active_status,
  case
    when max(last_customer_store_order_date) >= PARSE_DATE("%Y%m%d", @DS_START_DATE) and max(previous_last_customer_store_order_date) < date_sub(max(last_customer_store_order_date),interval 12 month) then 'reactivated'
    else 'not reactivated'
  end as reactivated_status,
  -- case
  --   when min(first_customer_store_order_date) >= PARSE_DATE("%Y%m%d", @DS_START_DATE) then 'Nouvel acheteur'
  --   else 'Ancien acheteur'
  -- end as recent_status,
  case
    when max(orders_count) > 0 and min(customer_created_date) >= PARSE_DATE("%Y%m%d", @DS_START_DATE) then 'Nouvel acheteur'
    when max(orders_count) > 0 and min(customer_created_date) < PARSE_DATE("%Y%m%d", @DS_START_DATE) then 'Ancien acheteur'
  end as recent_status,   
  max(orders_count) as orders_count,
  max(ca_ttc) as ca_ttc,
  max(order_sold_units) as sold_units
from
  layer1
group by
  date,
  store,
  customer_id
