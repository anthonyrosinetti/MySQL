select
    date,
    so.store,
    so.customer_id,
    case
      when count(distinct so.order_id) over w > 0 and so.customer_created_date >= PARSE_DATE("%Y%m%d", @DS_START_DATE) then 'Nouvel Acheteur'
      when count(distinct so.order_id) over w > 0 and so.customer_created_date < PARSE_DATE("%Y%m%d", @DS_START_DATE) then 'Ancien Acheteur'
    end as recent_status,
	case	
      when date_diff(current_date(), so.customer_birth_date, YEAR) - 
      if(format_date('%m-%d', current_date()) < format_date('%m-%d', so.customer_birth_date), 1, 0) < 20 then '[-20 ans]'
      when date_diff(current_date(), so.customer_birth_date, YEAR) - 
      if(format_date('%m-%d', current_date()) < format_date('%m-%d', so.customer_birth_date), 1, 0) < 35 then '[20 ans - 35 ans]'
      when date_diff(current_date(), so.customer_birth_date, YEAR) - 
      if(format_date('%m-%d', current_date()) < format_date('%m-%d', so.customer_birth_date), 1, 0) < 50 then '[35 ans - 50 ans]'
      when date_diff(current_date(), so.customer_birth_date, YEAR) - 
      if(format_date('%m-%d', current_date()) < format_date('%m-%d', so.customer_birth_date), 1, 0) >= 50 then '[+50 ans]'
	  else '-'
    end as age_range,
	case when so.customer_gender not in ('F','M') or so.customer_gender is null then '-' else so.customer_gender end as gender,
    cpc.region,
--    case when max(so.order_created_date) over w >= date_sub(date,interval 12 month) then 'active' else 'inactive' end as store_customer_active_status,    
--  case
--    when max(so.order_created_date) over w >= PARSE_DATE("%Y%m%d", @DS_START_DATE) and so.customer_created_date >= PARSE_DATE("%Y%m%d", @DS_START_DATE) then 'Nouvel acheteur'
--    when max(so.order_created_date) over w >= PARSE_DATE("%Y%m%d", @DS_START_DATE) and so.customer_created_date < PARSE_DATE("%Y%m%d", @DS_START_DATE) then 'Ancien acheteur'
--  end as recent_status,  
	case when sp.product_material is null then 'Autre' else sp.product_material end as product_material,
    case when sp.product_category is null or sp.product_category = 'Other' then 'Autre' else sp.product_category end as product_category
  from
    unnest(
            generate_date_array(
                PARSE_DATE("%Y%m%d", @DS_START_DATE),
                PARSE_DATE("%Y%m%d", @DS_END_DATE)
            )
        ) date
    left join
      `amasty-data.analysis.preanalysis_orders_splio` so
        on so.order_created_date = date
    left join
      `amasty-data.analysis.preanalysis_splio_store_to_product` sp
        using (product_id)
  	left join
      `amasty-data.config.postcodes` cpc
        on left(so.customer_postcode,2) = cpc.iso2_code
    window w as (
      partition by date,so.store,so.customer_id
    )
