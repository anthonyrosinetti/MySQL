with first_purchases as (
  select distinct
    customer_id,
    first_value(order_created_date) over w as first_purchase_date
  from
    `amasty-data.analysis.preanalysis_orders_splio_opt_in_only`
  window w as (
    partition by customer_id
    order by order_created_date asc
    ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING
  )
),

last_purchases as (
  select distinct
    customer_id,
    last_value(order_created_date) over w as last_order_date,
    lag(order_created_date) over w as previous_last_order_date
  from
    `amasty-data.analysis.preanalysis_orders_splio_opt_in_only`
  where
  	order_created_date <= PARSE_DATE("%Y%m%d", @DS_END_DATE)
    window w as (
      partition by customer_id
      order by order_created_date asc
    )
),

layer1 as (
  select
    o.store,
    o.customer_id,
	o.customer_created_date,  
    fp.first_purchase_date,
    lp.last_order_date,
    lp.previous_last_order_date
  from
      `amasty-data.analysis.preanalysis_orders_splio_opt_in_only`  o
    left join
      first_purchases fp
      on o.customer_id = fp.customer_id
    left join
      last_purchases lp
      on o.customer_id = lp.customer_id
  where o.order_created_date between PARSE_DATE("%Y%m%d", @DS_START_DATE) and PARSE_DATE("%Y%m%d", @DS_END_DATE)
)

select
  store,
  customer_id,
  case when first_purchase_date between PARSE_DATE("%Y%m%d", @DS_START_DATE) and PARSE_DATE("%Y%m%d", @DS_END_DATE) then true else false end as is_new,
  case when first_purchase_date < PARSE_DATE("%Y%m%d", @DS_START_DATE) then true else false end as is_returning,
  case when last_order_date between PARSE_DATE("%Y%m%d", @DS_START_DATE) and PARSE_DATE("%Y%m%d", @DS_END_DATE) and previous_last_order_date < date_sub(last_order_date,interval 12 month) then true else false end as is_reactivated
from
  layer1
