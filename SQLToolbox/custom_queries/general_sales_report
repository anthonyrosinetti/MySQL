with layer1 as (
    select
        o.date,
        split(o.species,',') as species_split,
        o.store,
        o.surtype,
        o.type,
        o.manufacturer,
        o.brand,
        o.product_sku,
        last_value(p.product_name) over (partition by o.product_sku order by p.updated_date asc) as product_name,               
        split(o.suppliers,',') as suppliers_split,
        o.item_total_revenue,
        o.item_total_quantity,
		o.item_margin,
        o.order_id
    from
        `reporting-boryl-lcda.analysis.analysis_orders` o
  		left join
         	`reporting-boryl-lcda.analysis.analysis_products` p
            	using (product_sku)
    where
        date(o.date) between parse_date("%Y%m%d", @DS_START_DATE) and parse_date("%Y%m%d", @DS_END_DATE)
)
, layer2 AS (
select
    date,
    ARRAY_CONCAT_AGG(species_split) as specie,
    store,
    surtype,
    type,
    manufacturer,
    brand,
    product_sku,
    product_name,
    ARRAY_CONCAT_AGG(suppliers_split) as supplier,
    count(distinct order_id) as orders_count,
    sum(item_total_revenue) as item_total_revenue,
    sum(item_total_quantity) as item_total_quantity,
	avg(item_margin) as item_margin
from
    layer1
group by
    date,store,surtype,type,manufacturer,brand,product_sku,product_name
)
SELECT
    date,
    ARRAY_TO_STRING(ARRAY(select distinct value from unnest(specie) as value),',') as specie,
    store,
    surtype,
    type,
    manufacturer,
    brand,
    product_sku,
    product_name,
    ARRAY_TO_STRING(ARRAY(select distinct value from unnest(supplier) as value),',') as supplier,
    orders_count,
    item_total_revenue,
    item_total_quantity,
	item_margin
from
    layer2
